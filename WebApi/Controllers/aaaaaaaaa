[HttpGet]
[Route("ObtenerProductosConVentas")]
public IActionResult ObtenerProductosConVentas()
{
    try
    {
        var productosConVentas = new List<ProductoVentaDto>();

        using (var conexion = new SqlConnection(cadenaSQL))
        {
            conexion.Open();
            var cmd = new SqlCommand(@"
                SELECT 
                    p.IdProducto,
                    p.Nombre,
                    p.Precio,
                    p.Stock,
                    (
                        SELECT SUM(v.Cantidad) 
                        FROM VentaVa v 
                        WHERE v.IdProducto = p.IdProducto
                    ) AS TotalVendidos
                FROM 
                    ProductoVa p
                WHERE 
                    p.Stock > 0", conexion);

            using (var reader = cmd.ExecuteReader())
            {
                while (reader.Read())
                {
                    var productoVenta = new ProductoVentaDto
                    {
                        IdProducto = (int)reader["IdProducto"],
                        Nombre = reader["Nombre"].ToString(),
                        Precio = (int)reader["Precio"],
                        Stock = (int)reader["Stock"],
                        TotalVendidos = reader["TotalVendidos"] as int? ?? 0 // Maneja posibles valores nulos
                    };
                    productosConVentas.Add(productoVenta);
                }
            }
        }

        return StatusCode(StatusCodes.Status200OK, new { mensaje = "Datos obtenidos", Response = productosConVentas });
    }
    catch (Exception error)
    {
        return StatusCode(StatusCodes.Status500InternalServerError, new { mensaje = error.Message });
    }
}
